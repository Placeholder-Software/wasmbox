"use strict";(self.webpackChunkwasmbox_docs=self.webpackChunkwasmbox_docs||[]).push([[8816],{3905:(e,n,a)=>{a.d(n,{Zo:()=>c,kt:()=>f});var t=a(7294);function r(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function o(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function i(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?o(Object(a),!0).forEach((function(n){r(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function s(e,n){if(null==e)return{};var a,t,r=function(e,n){if(null==e)return{};var a,t,r={},o=Object.keys(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||(r[a]=e[a]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=t.createContext({}),m=function(e){var n=t.useContext(l),a=n;return e&&(a="function"==typeof e?e(n):i(i({},n),e)),a},c=function(e){var n=m(e.components);return t.createElement(l.Provider,{value:n},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},u=t.forwardRef((function(e,n){var a=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=m(a),u=r,f=d["".concat(l,".").concat(u)]||d[u]||p[u]||o;return a?t.createElement(f,i(i({ref:n},c),{},{components:a})):t.createElement(f,i({ref:n},c))}));function f(e,n){var a=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=u;var s={};for(var l in n)hasOwnProperty.call(n,l)&&(s[l]=n[l]);s.originalType=e,s[d]="string"==typeof e?e:r,i[1]=s;for(var m=2;m<o;m++)i[m]=a[m];return t.createElement.apply(null,i)}return t.createElement.apply(null,a)}u.displayName="MDXCreateElement"},1347:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>m});var t=a(7462),r=(a(7294),a(3905));const o={title:"Custom WASM Instantiation",sidebar_position:3},i=void 0,s={unversionedId:"advanced/manual_loading",id:"advanced/manual_loading",title:"Custom WASM Instantiation",description:"Wasmbox provides behaviours to automatically load a WASM asset into a state that allows code to be run. However, it is possible to do this process directly in your own code to take complete control over the entire process.",source:"@site/docs/advanced/manual_loading.md",sourceDirName:"advanced",slug:"/advanced/manual_loading",permalink:"/wasmbox/advanced/manual_loading",draft:!1,editUrl:"https://github.com/Placeholder-Software/Wasmbox/tree/master/docs/advanced/manual_loading.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{title:"Custom WASM Instantiation",sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"Runtime WASM Loading",permalink:"/wasmbox/advanced/runtime_wasm_loading"},next:{title:"Determinism",permalink:"/wasmbox/advanced/determinism"}},l={},m=[{value:"Required Resources",id:"required-resources",level:2},{value:"Loading",id:"loading",level:2},{value:"Configuring",id:"configuring",level:2},{value:"Instantiating",id:"instantiating",level:2},{value:"Complete Example",id:"complete-example",level:2}],c={toc:m};function d(e){let{components:n,...a}=e;return(0,r.kt)("wrapper",(0,t.Z)({},c,a,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Wasmbox provides ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/simplewasmmonobehaviour"},"behaviours")," to automatically load a WASM asset into a state that allows code to be run. However, it is possible to do this process directly in your own code to take complete control over the entire process."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Refer to the ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/glossary"},"glossary")," for an overview of all the components involved.")),(0,r.kt)("h2",{id:"required-resources"},"Required Resources"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},"IWasmAsset Asset;\nEngineConfig Config;\n")),(0,r.kt)("p",null,"Before loading any WASM an ",(0,r.kt)("inlineCode",{parentName:"p"},"IWasmAsset")," and an ",(0,r.kt)("inlineCode",{parentName:"p"},"EngineConfig")," are required."),(0,r.kt)("p",null,"An ",(0,r.kt)("inlineCode",{parentName:"p"},"IWasmAsset")," represents a source that WASM can be loaded from. This may be a ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmasset"},(0,r.kt)("inlineCode",{parentName:"a"},"WasmAsset"))," (imported in editor) a ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/dynamicwasmasset"},(0,r.kt)("inlineCode",{parentName:"a"},"DynamicWasmAsset"))," (loaded at runtime from a file) or a custom ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/iwasmasset"},(0,r.kt)("inlineCode",{parentName:"a"},"IWasmAsset"))," implementation."),(0,r.kt)("p",null,"An ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/engineconfig"},(0,r.kt)("inlineCode",{parentName:"a"},"EngineConfig"))," configures how the WASM loaded from the asset should be compiled into executable code. Compile time features such as ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/basics/limiting_execution/fuelusage"},"Fuel Usage")," can be enabled."),(0,r.kt)("h2",{id:"loading"},"Loading"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'var module = Asset.Load(Config);\nif (module == null)\n    throw new Exception("Loading Failed");\n')),(0,r.kt)("p",null,"Loading the asset with an ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/engineconfig"},(0,r.kt)("inlineCode",{parentName:"a"},"EngineConfig"))," creates a ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/module"},(0,r.kt)("inlineCode",{parentName:"a"},"Module"))," which contains the compiled executable machine code in memory. If loading fails for some reason a ",(0,r.kt)("inlineCode",{parentName:"p"},"null")," object will be returned."),(0,r.kt)("admonition",{type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"Compiling a WASM Module is potentially a slow process if the asset is large and has not been ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/editor/import#4-compilation"},"precompiled"),".")),(0,r.kt)("h2",{id:"configuring"},"Configuring"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'var store = module.CreateStore();\n\nvar linker = module.CreateLinker();\nlinker.DefineFunction("demo", "add", (int a, int b) => a + b);\nlinker.DefineFunction("demo", "sub", (int a, int b) => a - b);\n')),(0,r.kt)("p",null,"To create an ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/instance"},(0,r.kt)("inlineCode",{parentName:"a"},"Instance"))," from a ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/module"},"module")," requires a ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/store"},(0,r.kt)("inlineCode",{parentName:"a"},"Store"))," and a ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/linker"},(0,r.kt)("inlineCode",{parentName:"a"},"Linker")),"."),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/linker"},(0,r.kt)("inlineCode",{parentName:"a"},"Linker"))," can be used to expose C# functions to WASM. See the ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/basics/linker"},"tutorial on linking")," for more information."),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/store"},(0,r.kt)("inlineCode",{parentName:"a"},"Store"))," contains all the ",(0,r.kt)("em",{parentName:"p"},"state")," of the executed WASM code. Multiple ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/instance"},(0,r.kt)("inlineCode",{parentName:"a"},"Instances"))," can share a ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/store"},(0,r.kt)("inlineCode",{parentName:"a"},"Store")),"."),(0,r.kt)("h2",{id:"instantiating"},"Instantiating"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'var instance = module.CreateInstance(linker, store);\n\nvar add = instance.GetFunction<int, int, int>("add");\nvar result = add(1, 2);\n')),(0,r.kt)("p",null,"Finally an ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/instance"},(0,r.kt)("inlineCode",{parentName:"a"},"Instance"))," can be created using the ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/module"},"module"),", ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/store"},(0,r.kt)("inlineCode",{parentName:"a"},"Store"))," and ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/linker"},(0,r.kt)("inlineCode",{parentName:"a"},"Linker")),"."),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/function"},(0,r.kt)("inlineCode",{parentName:"a"},"Functions")),", ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/memory"},(0,r.kt)("inlineCode",{parentName:"a"},"Memories")),", ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/table"},(0,r.kt)("inlineCode",{parentName:"a"},"Tables"))," and ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/global"},(0,r.kt)("inlineCode",{parentName:"a"},"Globals"))," can be retrieved from the ",(0,r.kt)("a",{parentName:"p",href:"/wasmbox/reference/code/wasmtime/instance"},(0,r.kt)("inlineCode",{parentName:"a"},"Instance"))," and used later."),(0,r.kt)("h2",{id:"complete-example"},"Complete Example"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-csharp"},'public class DemoWasmLoading\n    : MonoBehaviour\n{\n    private WasmAsset Asset;\n    private EngineConfig Config;\n\n    void OnEnable()\n    {\n        var module = Asset.Load(Config);\n        if (module == null)\n            throw new Exception("Loading Failed");\n\n        using var store = module.CreateStore();\n        using var linker = module.CreateLinker();\n        linker.DefineFunction("demo", "add", (int a, int b) => a + b);\n        linker.DefineFunction("demo", "sub", (int a, int b) => a - b);\n\n        var instance = module.CreateInstance(linker, store);\n        var add = instance.GetFunction<int, int, int>("add");\n\n        var result = add(1, 2);\n        Debug.Log(result);\n    }\n}\n')))}d.isMDXComponent=!0}}]);